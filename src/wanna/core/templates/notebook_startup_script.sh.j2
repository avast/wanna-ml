#!/bin/bash
{% if bucket_mounts is not none %}
{% for bucket_mount in bucket_mounts %}
sudo su -c "mkdir -p {{ bucket_mount["local_path"] }}"
sudo su -c "gcsfuse --implicit-dirs {{ ('--only-dir=' ~ bucket_mount["bucket_dir"]) if bucket_mount["bucket_dir"] }} {{ bucket_mount["bucket_name"] }} {{ bucket_mount["local_path"] }}"
{% endfor %}
{% endif %}

{% if tensorboard_resource_name is not none %}
export AIP_TENSORBOARD_LOG_DIR={{ tensorboard_resource_name }}
{% endif %}

{% if idle_shutdown_timeout is not none %}

cat > /shutdown_check.py <<EOF
import requests
from datetime import datetime
import os

datetime_format = "%Y-%m-%dT%H:%M:%S.%fZ"
idle_shutdown_timeout = {{idle_shutdown_timeout}}*60 # seconds

status = requests.get("http://localhost:8080/api/status").json()
notebook_started = datetime.strptime(status["started"], datetime_format)

if (datetime.now() - notebook_started).total_seconds() < idle_shutdown_timeout:
    # grace period after the notebook start
    os._exit(0)

kernels = requests.get("http://localhost:8080/api/kernels").json()
states = {kernel["execution_state"] for kernel in kernels}

if not states:
    # No kernels
    os.system('sudo poweroff')
elif states=={'idle'}:
    # only idle kernels
    last_activity = datetime.strptime(max([kernel["last_activity"] for kernel in kernels]), datetime_format)
    if (datetime.now() - last_activity).total_seconds() > idle_shutdown_timeout:
        os.system('sudo poweroff')

EOF

crontab -l | { cat; echo "*/10 * * * * /usr/conda/bin/python /shutdown_check.py"; } | crontab -

{% endif %}